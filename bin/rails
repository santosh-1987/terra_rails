#!/usr/bin/env ruby
# frozen_string_literal: true
require 'socket'

# Returns the index of the first argument in the command line argument list (ARGV array) which equals one of the
# given method arguments; otherwise, returns nil.
# If a block is provided, yields the block if at least one of the arguments expected is found.
def find_argument(*arguments)
  index = ARGV.find_index { |element| arguments.include?(element) }
  yield(index) if index && block_given?
  index
end

# Returns the index of the first argument in the command line argument list (ARGV array) which equals one of the
# given method arguments; otherwise, returns nil.
# If a block is provided, yields the block if at least one of the arguments expected is found.
# Also deletes the argument found.
def find_argument!(*arguments, &block)
  index = find_argument(*arguments, &block)
  ARGV.delete_at(index) if index
  index
end

# Support for server to be run with custom locale set
find_argument!('-l', '--locale') do |index|
  ENV['LOCALE'] ||= ARGV[index + 1]
  ARGV.delete_at(index + 1)
  puts "=> Locale is set to #{ENV['LOCALE']}"
end

# Only start up the webpack dev server if running the Rails server.
# All other Rails commands will ignore the webpack initializer from running.
find_argument('s', 'server') do |_index|
  ENV['WEBPACK_DEV_SERVER'] ||= 'true'
end

find_argument!('-r', '--remote') do |_index|
  hostname = Socket.gethostname.downcase
  ENV['SESSION_DOMAIN'] ||= hostname.include?('.cerner.com') ? hostname : "#{hostname}.cerner.com"
  puts "=> Session Domain is being set to #{ENV['SESSION_DOMAIN']}"
end

find_argument!('-s', '--services_env') do |index|
  ENV['SERVICES_ENV'] ||= ARGV[index + 1]
  ARGV.delete_at(index + 1)
end

# Rails 4.2 changed default host to localhost - which prevents local servers from being accessible on the network.
# Setting the IP binding to 0.0.0.0 restores this behavior.
# This enables one to use -m and -r options in development as earlier.
if ENV['SESSION_DOMAIN'] && !find_argument('-b')
  ARGV << '-b' << '0.0.0.0'
  puts '=> Setting 0.0.0.0 as default host for rails server'
end

ARGV << '--help' if ARGV.empty?
find_argument('-h', '--help') do |_index|
  puts <<-help_doc
Usage: Application-specific options for running locally
    -m, --multi                   Enables local testing of multi-tenancy.
                                  This allows the application to be accessed
                                  locally at <client>.registries.
                                  localhealthinent.com, for properly configured
                                  clients.
    -r, --remote                  Allows the application to be accessed remotely
                                  via the device hostname
                                  (e.g. mac-<associate-ID>.cerner.com).
                                  The application cannot be accessed at
                                  'localhost' when this option is in use.
    -s ENV, --services_env ENV    Specifies the application services environment
                                  to use. Available environments: 'local',
                                  'development' and 'staging'. Defaults to
                                  'local'.
  help_doc
end
APP_PATH = File.expand_path('../config/application', __dir__)
require_relative '../config/boot'
require 'rails/commands'
